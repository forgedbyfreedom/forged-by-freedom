name: ğŸ§  Forged By Freedom Transcript Builder + Sync

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # --------------------------------------
      # STEP 1: Checkout repo
      # --------------------------------------
      - name: ğŸ§¾ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # --------------------------------------
      # STEP 2: Set up Python
      # --------------------------------------
      - name: ğŸ Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # --------------------------------------
      # STEP 3: Install dependencies
      # --------------------------------------
      - name: ğŸ“¦ Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          pip install openai pinecone python-dotenv tqdm requests

      # --------------------------------------
      # STEP 4: Rebuild transcripts + index
      # --------------------------------------
      - name: ğŸ—ï¸ Build transcripts + file index
        run: |
          echo "ğŸ—ï¸ Rebuilding master transcripts..."
          python3 build_master_transcripts.py || true
          echo "âœ… Master transcripts rebuilt."

          echo "ğŸ“„ Updating transcript index..."
          python3 build_file_index.py || true
          echo "âœ… file_index.json updated."

          echo "ğŸ“¤ Checking for changes..."
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add transcripts/
          if git diff --cached --quiet; then
            echo "â„¹ï¸ No transcript or index changes detected."
            exit 0
          fi
          git commit -m "Auto update transcripts + file_index.json [skip ci]" || true
          git push https://${{ secrets.GH_PAT }}@github.com/forgedbyfreedom/forged-by-freedom.git main || true

      # --------------------------------------
      # STEP 4.5: Analyze transcript stats
      # --------------------------------------
      - name: ğŸ“Š Analyze transcript totals
        run: |
          echo "ğŸ“Š Running analyze_full_stats.py ..."
          python3 scripts/analyze_full_stats.py

      # --------------------------------------
      # STEP 5: Upload transcripts to Pinecone
      # --------------------------------------
      - name: ğŸ“¡ Upload transcripts to Pinecone
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          PINECONE_API_KEY: ${{ secrets.PINECONE_API_KEY }}
          PINECONE_INDEX_NAME: "forged-freedom-ai"
        run: |
          echo "ğŸ“¡ Uploading transcript chunks to Pinecone..."
          python3 scripts/pinecone_index_upload.py
          echo "âœ… Pinecone index updated."

      # --------------------------------------
      # STEP 6: Update OpenAI Assistant + cleanup
      # --------------------------------------
      - name: ğŸ§¹ Update OpenAI Assistant and remove old files
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ASSISTANT_ID: ${{ secrets.OPENAI_ASSISTANT_ID }}
        run: |
          python3 <<'PYCODE'
          import os, json
          from openai import OpenAI

          key = os.getenv("OPENAI_API_KEY")
          asst_id = os.getenv("ASSISTANT_ID")
          if not key or not asst_id:
              print("âš ï¸ Missing OpenAI credentials or Assistant ID.")
              raise SystemExit(0)

          client = OpenAI(api_key=key)
          if not os.path.exists("transcripts/file_index.json"):
              print("âš ï¸ file_index.json not found â€” skipping assistant update.")
              raise SystemExit(0)

          with open("transcripts/file_index.json", "r") as f:
              file_index = json.load(f)

          new_file_ids = [f.get("file_id") for f in file_index if f.get("file_id")]
          print(f"ğŸ”— Linking {len(new_file_ids)} files to assistant {asst_id}...")
          client.beta.assistants.update(asst_id, file_ids=new_file_ids)
          print("âœ… Assistant successfully updated.")

          all_files = client.files.list().data
          keep = set(new_file_ids)
          removed = 0
          for f in all_files:
              if f.id not in keep and f.filename.endswith("master_transcript1.txt"):
                  try:
                      client.files.delete(f.id)
                      removed += 1
                  except Exception as e:
                      print(f"âš ï¸ Could not delete file {f.id}: {e}")
          print(f"ğŸ§¹ Removed {removed} old transcript files.")
          PYCODE

      # --------------------------------------
      # STEP 7: Done
      # --------------------------------------
      - name: âœ… Done
        run: echo "ğŸ¯ All updates completed successfully."

name: üß† Forged By Freedom Transcript Builder + Sync

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # --------------------------------------
      # STEP 1: Checkout repo
      # --------------------------------------
      - name: üßæ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # --------------------------------------
      # STEP 2: Set up Python
      # --------------------------------------
      - name: üêç Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # --------------------------------------
      # STEP 3: Install dependencies
      # --------------------------------------
      - name: üì¶ Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          pip install openai pinecone python-dotenv tqdm requests

      # --------------------------------------
      # STEP 4: Rebuild transcripts + index
      # --------------------------------------
      - name: üèóÔ∏è Build transcripts + file index
        run: |
          echo "üèóÔ∏è Rebuilding master transcripts..."
          python3 build_master_transcripts.py || true
          echo "‚úÖ Master transcripts rebuilt."

          echo "üìÑ Updating transcript index..."
          python3 build_file_index.py || true
          echo "‚úÖ file_index.json updated."

          echo "üì§ Checking for changes..."
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add transcripts/
          if git diff --cached --quiet; then
            echo "‚ÑπÔ∏è No transcript or index changes detected."
            exit 0
          fi
          git commit -m "Auto update transcripts + file_index.json [skip ci]" || true
          git push https://${{ secrets.GH_PAT }}@github.com/forgedbyfreedom/forged-by-freedom.git main || true

      # --------------------------------------
      # STEP 4.5: Analyze transcript stats
      # --------------------------------------
      - name: üìä Analyze transcript totals
        run: |
          echo "üìä Running analyze_full_stats.py ..."
          python3 scripts/analyze_full_stats.py


      # --------------------------------------
      # STEP 5: Sync updates to dashboard repo
      # --------------------------------------
      - name: üöÄ Sync transcripts + index to dashboard repo
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          GH_USER: forgedbyfreedom
          DASHBOARD_REPO: forgedbyfreedom/forged-by-freedom-dashboard
        run: |
          echo "üì§ Syncing to dashboard repo..."
          git clone https://${GH_USER}:${GH_PAT}@github.com/${DASHBOARD_REPO}.git /tmp/dashboard
          mkdir -p /tmp/dashboard/transcripts
          cp transcripts/*/master_transcript*.txt /tmp/dashboard/transcripts/ 2>/dev/null || true
          cp transcripts/file_index.json transcripts/stats.json /tmp/dashboard/transcripts/ || true
          cd /tmp/dashboard
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add transcripts/
          if git diff --cached --quiet; then
            echo "‚ÑπÔ∏è No dashboard updates detected."
            exit 0
          fi
          git commit -m "Sync transcripts + file index [skip ci]" || true
          git push https://${GH_USER}:${GH_PAT}@github.com/${DASHBOARD_REPO}.git main || true

      # --------------------------------------
      # STEP 6: Update OpenAI Assistant + cleanup
      # --------------------------------------
      - name: üßπ Update OpenAI Assistant and remove old files
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ASSISTANT_ID: ${{ secrets.OPENAI_ASSISTANT_ID }}
        run: |
          python3 <<'PYCODE'
          import os, json
          from openai import OpenAI

          key = os.getenv("OPENAI_API_KEY")
          asst_id = os.getenv("ASSISTANT_ID")
          if not key or not asst_id:
              print("‚ö†Ô∏è Missing OpenAI credentials or Assistant ID.")
              raise SystemExit(0)

          client = OpenAI(api_key=key)
          if not os.path.exists("transcripts/file_index.json"):
              print("‚ö†Ô∏è file_index.json not found ‚Äî skipping assistant update.")
              raise SystemExit(0)

          with open("transcripts/file_index.json", "r") as f:
              file_index = json.load(f)

          new_file_ids = [f.get("file_id") for f in file_index if f.get("file_id")]
          print(f"üîó Linking {len(new_file_ids)} files to assistant {asst_id}...")
          client.beta.assistants.update(asst_id, file_ids=new_file_ids)
          print("‚úÖ Assistant successfully updated.")

          all_files = client.files.list().data
          keep = set(new_file_ids)
          removed = 0
          for f in all_files:
              if f.id not in keep and f.filename.endswith("master_transcript1.txt"):
                  try:
                      client.files.delete(f.id)
                      removed += 1
                  except Exception as e:
                      print(f"‚ö†Ô∏è Could not delete file {f.id}: {e}")
          print(f"üßπ Removed {removed} old transcript files.")
          PYCODE

      # --------------------------------------
      # STEP 7: Done
      # --------------------------------------
      - name: ‚úÖ Done
        run: echo "üéØ All updates completed successfully."

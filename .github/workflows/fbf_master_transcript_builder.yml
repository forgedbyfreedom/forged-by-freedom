name: üîÅ Full Transcript Build + Index + Sync + Assistant Update

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * *"  # üïí Every night at 3 AM UTC

permissions:
  contents: write

env:
  GH_USER: forgedbyfreedom
  GH_PAT: ${{ secrets.FBF_PAT }}
  DASHBOARD_REPO: forgedbyfreedom/forged-by-freedom-st
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  ASSISTANT_ID: ${{ secrets.OPENAI_ASSISTANT_ID }}
  PINECONE_API_KEY: ${{ secrets.PINECONE_API_KEY }}
  PINECONE_INDEX: forgedbyfreedom-index

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: üß≠ Checkout repository
        uses: actions/checkout@v4

      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: üì¶ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install openai pinecone tqdm requests python-dotenv beautifulsoup4

      # --------------------------------------
      # STEP 1: Build all master transcripts
      # --------------------------------------
      - name: üß† Build deduped master transcripts
        run: |
          if [ -f transcripts/build_master_transcripts.py ]; then
            python transcripts/build_master_transcripts.py
          elif [ -f build_master_transcripts.py ]; then
            python build_master_transcripts.py
          else
            echo "‚ö†Ô∏è No build_master_transcripts.py found, skipping."
          fi

      # --------------------------------------
      # STEP 2: Build file_index.json
      # --------------------------------------
      - name: üóÇÔ∏è Build updated file index
        run: |
          if [ -f transcripts/index_transcripts.py ]; then
            python transcripts/index_transcripts.py
          elif [ -f index_transcripts.py ]; then
            python index_transcripts.py
          else
            echo "‚ö†Ô∏è No index_transcripts.py found, skipping file index."
          fi

      # --------------------------------------
      # STEP 3: Sync deduped transcripts to Pinecone
      # --------------------------------------
      - name: üîó Sync deduped transcripts to Pinecone
        run: |
          if [ -f transcripts/sync_local_transcripts_to_pinecone.py ]; then
            python transcripts/sync_local_transcripts_to_pinecone.py
          elif [ -f sync_local_transcripts_to_pinecone.py ]; then
            python sync_local_transcripts_to_pinecone.py
          else
            echo "‚ö†Ô∏è No Pinecone sync script found, skipping."
          fi

      # --------------------------------------
      # STEP 4: Commit transcript & index updates
      # --------------------------------------
      - name: üíæ Commit transcript updates
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          if git diff --cached --quiet; then
            echo "‚ÑπÔ∏è No new transcript or index changes detected."
            exit 0
          fi
          git commit -m "Auto update transcripts + file_index.json [skip ci]" || true
          git push https://${GH_USER}:${GH_PAT}@github.com/${GH_USER}/forged-by-freedom.git main || true

      # --------------------------------------
      # STEP 5: Sync updates to dashboard repo
      # --------------------------------------
      - name: üöÄ Sync transcripts + index to dashboard repo
        run: |
          echo "üì§ Syncing to dashboard repo..."
          git clone https://${GH_USER}:${GH_PAT}@github.com/${DASHBOARD_REPO}.git /tmp/dashboard
          mkdir -p /tmp/dashboard/transcripts
          cp transcripts/*/master_transcript*.txt /tmp/dashboard/transcripts/ 2>/dev/null || true
          cp transcripts/file_index.json /tmp/dashboard/transcripts/ || true
          cd /tmp/dashboard
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add transcripts/
          if git diff --cached --quiet; then
            echo "‚ÑπÔ∏è No dashboard updates detected."
            exit 0
          fi
          git commit -m "Sync transcripts + file index [skip ci]" || true
          git push https://${GH_USER}:${GH_PAT}@github.com/${DASHBOARD_REPO}.git main || true

      # --------------------------------------
      # STEP 6: Update OpenAI Assistant + cleanup
      # --------------------------------------
      - name: üßπ Update OpenAI Assistant and remove old files
        run: |
          python3 <<'PYCODE'
          import os, json
          from openai import OpenAI

          key = os.getenv("OPENAI_API_KEY")
          asst_id = os.getenv("ASSISTANT_ID")
          if not key or not asst_id:
              print("‚ö†Ô∏è Missing OpenAI credentials or Assistant ID.")
              raise SystemExit(0)

          client = OpenAI(api_key=key)
          if not os.path.exists("transcripts/file_index.json"):
              print("‚ö†Ô∏è file_index.json not found ‚Äî skipping assistant update.")
              raise SystemExit(0)

          with open("transcripts/file_index.json", "r") as f:
              file_index = json.load(f)

          new_file_ids = [f.get("file_id") for f in file_index if f.get("file_id")]
          print(f"üîó Linking {len(new_file_ids)} files to assistant {asst_id}...")
          client.beta.assistants.update(asst_id, file_ids=new_file_ids)
          print("‚úÖ Assistant successfully updated.")

          all_files = client.files.list().data
          keep = set(new_file_ids)
          removed = 0
          for f in all_files:
              if f.id not in keep and f.filename.endswith("master_transcript1.txt"):
                  try:
                      client.files.delete(f.id)
                      removed += 1
                  except Exception as e:
                      print(f"‚ö†Ô∏è Could not delete {f.id}: {e}")
          print(f"üßΩ Cleanup complete. Removed {removed} old files.")
          PYCODE

      # --------------------------------------
      # STEP 7: Summary for GitHub Logs
      # --------------------------------------
      - name: ‚úÖ Summary
        run: |
          echo "üéØ Full pipeline complete."
          echo "üß† Transcripts rebuilt"
          echo "üóÇÔ∏è File index regenerated"
          echo "üîó Synced to Pinecone + Dashboard"
          echo "ü§ñ Assistant updated successfully"

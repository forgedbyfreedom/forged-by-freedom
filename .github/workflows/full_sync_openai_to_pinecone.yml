name: ğŸŒ Full OpenAI â†’ Pinecone Sync (Guaranteed Clean Build)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 5 * * *"

permissions:
  contents: read

jobs:
  full-sync:
    runs-on: ubuntu-latest

    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      PINECONE_API_KEY: ${{ secrets.PINECONE_API_KEY }}
      PINECONE_INDEX_NAME: forged-freedom-ai
      PINECONE_ENVIRONMENT: us-east-1

    steps:
      - name: ğŸ§­ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # ğŸ”¥ Layer 1 â€“ Force-remove all traces of Pinecone
      - name: ğŸ§¹ Full Pinecone purge
        run: |
          pip uninstall -y pinecone-client pinecone || true
          rm -rf /usr/local/lib/python*/site-packages/pinecone* || true
          rm -rf /opt/hostedtoolcache/Python /home/runner/.cache/pip || true
          echo "âœ… Old Pinecone completely purged"

      # ğŸ”¥ Layer 2 â€“ Install correct SDK explicitly
      - name: ğŸ“¦ Install clean dependencies
        run: |
          python -m pip install --upgrade pip
          pip install --no-cache-dir openai pinecone tqdm requests python-dotenv
          echo "âœ… Installed new Pinecone SDK"
          pip list | grep pinecone || echo "âŒ Pinecone not found"

      # ğŸ”¥ Layer 3 â€“ Run a check BEFORE your sync script
      - name: ğŸ§  Verify correct Pinecone import
        run: |
          python - <<'EOF'
          import importlib, sys
          try:
              pc = importlib.import_module("pinecone")
              assert hasattr(pc, "Pinecone"), "Wrong Pinecone package still present!"
              print("âœ… Correct Pinecone SDK confirmed:", pc.__file__)
          except Exception as e:
              print("âŒ Pinecone verification failed:", e)
              sys.exit(1)
          EOF

      - name: ğŸš€ Run full sync
        run: python backend/full_sync_openai_to_pinecone.py

      - name: âœ… Done
        run: echo "ğŸ¯ Pinecone sync completed successfully!"

name: ğŸ” Full Sync â€” AI Coach Data to Pinecone

on:
  workflow_dispatch:
  schedule:
    - cron: "0 6 * * *" # every day at 6 AM UTC

permissions:
  contents: read

env:
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  PINECONE_API_KEY: ${{ secrets.PINECONE_API_KEY }}
  PINECONE_INDEX: ai-coach-knowledge

jobs:
  full-sync:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: ğŸ§­ Checkout repo
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install openai pinecone python-dotenv tqdm requests

      - name: ğŸ§ª Verify Pinecone SDK version
        run: |
          python -c "import pinecone; print('âœ… Pinecone version:', pinecone.__version__)"
          python -c "import openai; print('âœ… OpenAI version:', openai.__version__)"

      - name: ğŸ§¹ Sanitize filenames before syncing
        run: |
          if [ -f backend/sanitize_filenames.py ]; then
            python backend/sanitize_filenames.py
          else
            echo "âš ï¸ sanitize_filenames.py not found, skipping..."
          fi

      - name: ğŸš€ Run unified ingestion sync (AI Coach data â†’ Pinecone)
        run: |
          if [ -f sync_gpt_ingest.py ]; then
            python sync_gpt_ingest.py
          elif [ -f backend/full_sync_openai_to_pinecone.py ]; then
            python backend/full_sync_openai_to_pinecone.py
          else
            echo "âŒ No ingestion script found. Please add sync_gpt_ingest.py to repo root."
            exit 1
          fi

      - name: âœ… Summary
        run: echo "ğŸ¯ Full Pinecone sync complete â€” all transcripts and references indexed."

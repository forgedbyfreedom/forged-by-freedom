name: üîÅ Auto Sync & Push All Transcripts to Pinecone (Direct Upload)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 6 * * *"  # Every day at 6 AM UTC

permissions:
  contents: write

env:
  GH_USER: forgedbyfreedom
  GH_PAT: ${{ secrets.FBF_PAT }}
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  PINECONE_API_KEY: ${{ secrets.PINECONE_API_KEY }}
  PINECONE_INDEX_NAME: forged-freedom-ai

jobs:
  sync-pinecone:
    runs-on: ubuntu-latest

    steps:
      - name: üß≠ Checkout repo
        uses: actions/checkout@v4

      - name: üß© Clone ThinkBig transcripts
        run: |
          echo "üì• Cloning ThinkBig transcripts..."
          git clone https://${GH_USER}:${GH_PAT}@github.com/forgedbyfreedom/thinkbig-transcripts.git /tmp/thinkbig
          mkdir -p transcripts/thinkbig
          cp -r /tmp/thinkbig/* transcripts/thinkbig/ || true
          echo "‚úÖ ThinkBig transcripts copied."

      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: üì¶ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install openai pinecone-client tqdm requests python-dotenv

      - name: üöÄ Direct Pinecone Sync (no rebuild needed)
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          PINECONE_API_KEY: ${{ secrets.PINECONE_API_KEY }}
          PINECONE_INDEX_NAME: ${{ secrets.PINECONE_INDEX_NAME }}
        run: |
          python - <<'PYCODE'
          import os, pinecone, openai
          from tqdm import tqdm

          pinecone.init(api_key=os.environ["PINECONE_API_KEY"], environment="us-east1-gcp")
          index = pinecone.Index(os.environ["PINECONE_INDEX_NAME"])

          base_dirs = ["transcripts", "transcripts/thinkbig"]
          all_files = []

          for folder in base_dirs:
              for root, _, files in os.walk(folder):
                  for f in files:
                      if f.endswith((".txt", ".json")):
                          all_files.append(os.path.join(root, f))

          total_words = 0
          print(f"üìÑ Found {len(all_files)} transcript files. Uploading to Pinecone...")

          for path in tqdm(all_files):
              try:
                  with open(path, "r", errors="ignore") as fp:
                      text = fp.read().strip()
                  if not text:
                      continue
                  total_words += len(text.split())
                  emb = openai.embeddings.create(
                      input=text[:5000], model="text-embedding-3-small"
                  ).data[0].embedding
                  index.upsert([(path, emb, {"source": os.path.basename(path)})])
              except Exception as e:
                  print(f"‚ö†Ô∏è Skipping {path}: {e}")

          print(f"\n‚úÖ Pinecone sync complete!")
          print(f"üìä Uploaded {len(all_files)} files")
          print(f"üìù Total words processed: {total_words:,}")
          PYCODE

      - name: ‚úÖ Done
        run: echo "‚úÖ Full direct sync completed successfully!"
      - name: üìà Show Pinecone Totals
        env:
          PINECONE_API_KEY: ${{ secrets.PINECONE_API_KEY }}
          PINECONE_INDEX_NAME: ${{ secrets.PINECONE_INDEX_NAME }}
        run: |
          python - <<'PYCODE'
          import os
          import pinecone

          print("\nüîç Checking Pinecone index stats...\n")

          try:
              pinecone.init(api_key=os.environ["PINECONE_API_KEY"], environment="us-east1-gcp")
              index = pinecone.Index(os.environ["PINECONE_INDEX_NAME"])
              stats = index.describe_index_stats()

              total_vectors = stats.get("total_vector_count", 0)
              namespaces = list(stats.get("namespaces", {}).keys())
              dim = stats.get("dimension", "unknown")

              print("üìä Pinecone Index Totals")
              print(f"üß† Index: {os.environ['PINECONE_INDEX_NAME']}")
              print(f"üì¶ Namespaces: {namespaces if namespaces else ['default']}")
              print(f"üî¢ Total vectors: {total_vectors:,}")
              print(f"üìè Embedding dimension: {dim}")
              print(f"üíæ Approx. size: {total_vectors * int(dim) * 4 / 1e6 if dim != 'unknown' else 'N/A'} MB")

              print("\n‚úÖ Pinecone totals check complete!\n")
          except Exception as e:
              print(f"‚ö†Ô∏è Error checking Pinecone stats: {e}")
          PYCODE

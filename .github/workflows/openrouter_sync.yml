name: üß† OpenRouter + Pinecone Sync

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: üßæ Checkout repository
        uses: actions/checkout@v4

      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: üì¶ Full Clean Install of Dependencies
        run: |
          echo "üßπ Cleaning environment..."
          pip uninstall -y pinecone pinecone-client || true
          pip cache purge || true

          echo "üì¶ Installing clean dependencies..."
          python3 -m pip install --upgrade pip
          pip install --no-cache-dir pinecone openai python-dotenv tqdm flask flask-cors requests tiktoken numpy

          echo "‚úÖ Verifying Pinecone SDK version..."
          python3 -c "import pinecone; print('‚úÖ Pinecone SDK version:', pinecone.__version__)"

      - name: üì° Verify environment
        run: |
          echo "‚úÖ Using model: $OPENROUTER_MODEL"
          echo "‚úÖ Using Pinecone Index: $PINECONE_INDEX_NAME"
          echo "‚úÖ OpenRouter Base URL: $OPENROUTER_BASE_URL"
        env:
          OPENROUTER_MODEL: ${{ secrets.OPENROUTER_MODEL }}
          OPENROUTER_BASE_URL: ${{ secrets.OPENROUTER_BASE_URL }}
          PINECONE_INDEX_NAME: ${{ secrets.PINECONE_INDEX_NAME }}

      - name: üîç Test app import
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          OPENROUTER_BASE_URL: ${{ secrets.OPENROUTER_BASE_URL }}
          OPENROUTER_MODEL: ${{ secrets.OPENROUTER_MODEL }}
          PINECONE_API_KEY: ${{ secrets.PINECONE_API_KEY }}
          PINECONE_INDEX_NAME: ${{ secrets.PINECONE_INDEX_NAME }}
        run: |
          python3 -c "from app import app; print('‚úÖ Flask app loaded successfully')"

      - name: üîå Test OpenRouter & Pinecone connectivity
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          PINECONE_API_KEY: ${{ secrets.PINECONE_API_KEY }}
          PINECONE_INDEX_NAME: ${{ secrets.PINECONE_INDEX_NAME }}
        run: |
          python3 - <<'PYCODE'
          from openai import OpenAI
          from pinecone import Pinecone

          print("üîç Testing OpenRouter + Pinecone connections...")

          client = OpenAI(api_key="${{ secrets.OPENROUTER_API_KEY }}", base_url="https://openrouter.ai/api/v1")
          pc = Pinecone(api_key="${{ secrets.PINECONE_API_KEY }}")
          index = pc.Index("${{ secrets.PINECONE_INDEX_NAME }}")

          emb = client.embeddings.create(model="text-embedding-3-small", input="connection test").data[0].embedding
          print("‚úÖ Embedding test successful ‚Äî length:", len(emb))
          print("‚úÖ Pinecone index connection:", index.describe_index_stats())
          PYCODE

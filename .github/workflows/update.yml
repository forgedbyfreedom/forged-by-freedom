name: ğŸ§  Forged By Freedom Full Rebuild + Pinecone Sync

on:
  workflow_dispatch:    # manual trigger
  push:
    branches:
      - main            # run automatically when pushing to main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # --------------------------------------
      # 1ï¸âƒ£ Checkout the latest repo version
      # --------------------------------------
      - name: ğŸ§¾ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # --------------------------------------
      # 2ï¸âƒ£ Set up Python
      # --------------------------------------
      - name: ğŸ Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # --------------------------------------
      # 3ï¸âƒ£ Install and verify dependencies
      # --------------------------------------
      - name: ğŸ§¹ Clear pip cache
        run: pip cache purge || true
        
      - name: ğŸ“¦ Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          # âœ… Remove deprecated Pinecone client
          pip uninstall -y pinecone-client || true
          # âœ… Install correct SDK and dependencies
          pip install pinecone openai python-dotenv tqdm flask flask-cors requests tiktoken numpy
          # âœ… Confirm Pinecone version
          python3 -c "import pinecone; print('âœ… Pinecone SDK:', pinecone.__version__)"

      # --------------------------------------
      # 4ï¸âƒ£ Pull the latest repo changes (ensure sync)
      # --------------------------------------
      - name: ğŸ”„ Pull latest repo changes
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git fetch origin main
          git pull origin main || echo "â„¹ï¸ No new changes to pull."

      # --------------------------------------
      # 5ï¸âƒ£ Rebuild master transcripts
      # --------------------------------------
      - name: ğŸ—ï¸ Rebuild master transcripts
        run: |
          echo "ğŸ—ï¸ Rebuilding master transcripts..."
          python3 scripts/build_master_transcripts.py || true
          echo "âœ… Master transcripts rebuilt."

      # --------------------------------------
      # 6ï¸âƒ£ Build file and channel indexes
      # --------------------------------------
      - name: ğŸ§± Build file + channel indexes
        run: |
          echo "ğŸ“„ Building file_index.json and channel indexes..."
          python3 scripts/build_file_index.py || true
          python3 scripts/build_channels_index.py || true
          echo "âœ… Indexes updated."

      # --------------------------------------
      # 7ï¸âƒ£ Generate database statistics
      # --------------------------------------
      - name: ğŸ“ˆ Generate stats
        env:
          PINECONE_API_KEY: ${{ secrets.PINECONE_API_KEY }}
          PINECONE_INDEX_NAME: ${{ secrets.PINECONE_INDEX_NAME }}
        run: |
          echo "ğŸ“Š Running full stats analysis..."
          python3 scripts/analyze_full_stats.py || true
          echo "âœ… Stats.json updated."

      # --------------------------------------
      # 8ï¸âƒ£ Smart Pinecone sync (upload new/changed files only)
      # --------------------------------------
      - name: ğŸ“¡ Upload to Pinecone
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          PINECONE_API_KEY: ${{ secrets.PINECONE_API_KEY }}
          PINECONE_INDEX_NAME: ${{ secrets.PINECONE_INDEX_NAME }}
        run: |
          echo "ğŸ“¡ Syncing data to Pinecone..."
          python3 scripts/smart_pinecone_sync.py || true
          echo "âœ… Pinecone index updated successfully."

      # --------------------------------------
      # 9ï¸âƒ£ Commit + Push updates safely
      # --------------------------------------
      - name: ğŸš€ Commit and push updates
        env:
          GH_USER: forgedbyfreedom
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "Automated rebuild + Pinecone sync [skip ci]" || echo "â„¹ï¸ No new changes."
          git pull --rebase origin main || true
          git push https://${GH_USER}:${GH_PAT}@github.com/${GH_USER}/forged-by-freedom.git main || echo "âœ… Up to date."

      # --------------------------------------
      # ğŸ”Ÿ Done
      # --------------------------------------
      - name: âœ… Done
        run: echo "ğŸ¯ All transcripts, stats, and Pinecone sync complete."

name: ğŸ” Auto Update Transcripts + Stats

on:
  workflow_dispatch:    # manual trigger in GitHub
  push:
    branches:
      - main            # auto-run on push to main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # --------------------------------------
      # 1ï¸âƒ£ Checkout repository
      # --------------------------------------
      - name: ğŸ§¾ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # --------------------------------------
      # 2ï¸âƒ£ Set up Python environment
      # --------------------------------------
      - name: ğŸ Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # --------------------------------------
      # 3ï¸âƒ£ Install dependencies
      # --------------------------------------
      - name: ğŸ“¦ Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          pip install pinecone openai tiktoken numpy

      # --------------------------------------
      # 4ï¸âƒ£ Rebuild master transcripts
      # --------------------------------------
      - name: ğŸ—ï¸ Rebuild master transcripts
        run: |
          echo "ğŸ—ï¸ Rebuilding all master transcripts..."
          python3 scripts/build_master_transcripts.py
          echo "âœ… Transcript rebuild completed."

      # --------------------------------------
      # 5ï¸âƒ£ Generate stats.json summary
      # --------------------------------------
      - name: ğŸ“ˆ Generate site stats (text + Pinecone)
        env:
          PINECONE_API_KEY: ${{ secrets.PINECONE_API_KEY }}
          PINECONE_INDEX: "forgedbyfreedom"
        run: |
          echo "ğŸ“Š Running analyze_full_stats.py ..."
          python3 scripts/analyze_full_stats.py
          echo "âœ… Stats generated."

      # --------------------------------------
      # 6ï¸âƒ£ Commit & push changes back to repo
      # --------------------------------------
      - name: ğŸš€ Commit and push updates
        env:
          GH_USER: forgedbyfreedom
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          echo "ğŸ“¤ Adding and committing changes..."
          git add -A
          git commit -m "Auto update transcripts + stats.json [skip ci]" || echo "â„¹ï¸ No changes to commit."

          echo "ğŸ“¤ Pushing to main..."
          git push https://${GH_USER}:${GH_PAT}@github.com/${GH_USER}/thinkbig-transcripts.git main || echo "âœ… Push skipped if up to date."

      # --------------------------------------
      # 7ï¸âƒ£ Display summary
      # --------------------------------------
      - name: âœ… Done
        run: |
          echo "ğŸ¯ All transcripts and stats updated successfully."
